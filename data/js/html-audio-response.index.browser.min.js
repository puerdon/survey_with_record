var jsPsychHtmlAudioResponse=function(t){"use strict";function e(t,e){for(var a=0;a<e.length;a++){var r=e[a];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}var a={name:"html-audio-response",parameters:{stimulus:{type:t.ParameterType.HTML_STRING,default:void 0},stimulus_duration:{type:t.ParameterType.INT,default:null},recording_duration:{type:t.ParameterType.INT,default:2e3},show_done_button:{type:t.ParameterType.BOOL,default:!0},done_button_label:{type:t.ParameterType.STRING,default:"Continue"},record_again_button_label:{type:t.ParameterType.STRING,default:"Record again"},accept_button_label:{type:t.ParameterType.STRING,default:"Continue"},allow_playback:{type:t.ParameterType.BOOL,default:!1},save_audio_url:{type:t.ParameterType.BOOL,default:!1},show_start_button:{type:t.ParameterType.BOOL,default:!0},start_button_label:{type:t.ParameterType.STRING,default:"開始錄音"},show_textarea:{type:t.ParameterType.BOOL,default:!0},image_name:{type:t.ParameterType.STRING,default:!0}}},r=function(){function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.jsPsych=e,this.rt=null,this.recorded_data_chunks=[]}var a,r,n;return a=t,(r=[{key:"trial",value:function(t,e){this.recorder=this.jsPsych.pluginAPI.getMicrophoneRecorder(),this.setupRecordingEvents(t,e),e.show_start_button||(console.log("if (!trial.show_start_button)"),this.startRecording()),this.showDisplay(t,e),this.addButtonEvent(t,e)}},{key:"showDisplay",value:function(t,e){var a=this;new ResizeObserver((function(e,r){a.stimulus_start_time=performance.now(),r.unobserve(t)})).observe(t);var r='<div id="jspsych-html-audio-response-stimulus"><p>請以族語描述下圖情境：</p>\n        <img src="images/'.concat(e.image_name,'" width="90%"></div>');console.log(e.show_textarea),e.show_textarea&&(r+='<p>請在下方欄位輸入族語文字（您可以自行選擇是否要輸入）</p><textarea id="ab" name="ab"\n          rows="5" cols="33"></textarea>'),e.show_start_button&&(r+='<p><button class="jspsych-btn" id="start-trial">'.concat(e.start_button_label,"</button></p>")),e.show_done_button&&(r+='<p><button class="jspsych-btn" id="finish-trial">'.concat(e.done_button_label,"</button></p>")),t.innerHTML=r}},{key:"hideStimulus",value:function(t){var e=t.querySelector("#jspsych-html-audio-response-stimulus");e&&(e.style.visibility="hidden")}},{key:"addButtonEvent",value:function(t,e){var a=this,r=t.querySelector("#finish-trial");r&&r.addEventListener("click",(function(){var r=performance.now();a.rt=Math.round(r-a.stimulus_start_time),a.stopRecording().then((function(){clearInterval(a.interval_id),e.allow_playback?a.showPlaybackControls(t,e):a.endTrial(t,e)}))}));var n=t.querySelector("#start-trial");n&&n.addEventListener("click",(function(){console.log(),console.log("recording_duration: "+e.recording_duration.toString()),a.startRecording();var t=e.recording_duration/1e3;n.innerHTML="正在錄音... ".concat(t,":00"),console.log("這裡"),a.interval_id=setInterval((function(){console.log("total: ".concat(t)),t-=1,n.innerHTML="正在錄音... ".concat(t,":00"),t<=0&&(console.log("clearInterval();"),clearInterval(a.interval_id))}),1e3),console.log("interval_id: ".concat(a.interval_id))}))}},{key:"setupRecordingEvents",value:function(t,e){var a=this;this.data_available_handler=function(t){t.data.size>0&&a.recorded_data_chunks.push(t.data)},this.stop_event_handler=function(){var r=new Blob(a.recorded_data_chunks,{type:"audio/mpeg"});a.audio_url=URL.createObjectURL(r);var n=new FileReader;if(n.addEventListener("load",(function(){var t=n.result.split(",")[1];a.response=t,a.load_resolver()})),n.readAsDataURL(r),e.show_textarea){var o=t.querySelector("#ab");a.textarea=o.value}},this.start_event_handler=function(r){console.log("start_event fired"),a.recorded_data_chunks.length=0,a.recorder_start_time=r.timeStamp,e.show_start_button||(a.showDisplay(t,e),a.addButtonEvent(t,e)),t.querySelector("#start-trial"),null!==e.stimulus_duration&&a.jsPsych.pluginAPI.setTimeout((function(){a.hideStimulus(t)}),e.stimulus_duration),null!==e.recording_duration&&a.jsPsych.pluginAPI.setTimeout((function(){"inactive"!==a.recorder.state&&a.stopRecording().then((function(){e.allow_playback?a.showPlaybackControls(t,e):a.endTrial(t,e)}))}),e.recording_duration)},this.recorder.addEventListener("dataavailable",this.data_available_handler),this.recorder.addEventListener("stop",this.stop_event_handler),this.recorder.addEventListener("start",this.start_event_handler)}},{key:"startRecording",value:function(){console.log("recording start!!!!!"),this.recorder.start()}},{key:"stopRecording",value:function(){var t=this;return this.recorder.stop(),new Promise((function(e){t.load_resolver=e}))}},{key:"showPlaybackControls",value:function(t,e){var a=this;t.innerHTML='\n      <p><audio id="playback" src="'.concat(this.audio_url,'" controls></audio></p>\n      <button id="record-again" class="jspsych-btn">').concat(e.record_again_button_label,'</button>\n      <button id="continue" class="jspsych-btn">').concat(e.accept_button_label,"</button>\n    "),e.show_textarea&&(t.innerHTML="<p>您所輸入的族語：</p><p>".concat(this.textarea,"</p>")+t.innerHTML),t.querySelector("#record-again").addEventListener("click",(function(){URL.revokeObjectURL(a.audio_url),a.showDisplay(t,e),a.addButtonEvent(t,e)})),t.querySelector("#continue").addEventListener("click",(function(){a.endTrial(t,e)}))}},{key:"endTrial",value:function(t,e){this.recorder.removeEventListener("dataavailable",this.data_available_handler),this.recorder.removeEventListener("start",this.start_event_handler),this.recorder.removeEventListener("stop",this.stop_event_handler),this.jsPsych.pluginAPI.clearAllTimeouts();var a={rt:this.rt,stimulus:e.stimulus,response:this.response,estimated_stimulus_onset:Math.round(this.stimulus_start_time-this.recorder_start_time),textarea:this.textarea,image_name:e.image_name};e.save_audio_url?a.audio_url=this.audio_url:URL.revokeObjectURL(this.audio_url),t.innerHTML="",this.jsPsych.finishTrial(a)}}])&&e(a.prototype,r),n&&e(a,n),Object.defineProperty(a,"prototype",{writable:!1}),t}();return r.info=a,r}(jsPsychModule);
//# sourceMappingURL=index.browser.min.js.map
