var jsPsychHtmlAudioResponse=function(e){"use strict";function t(e,t){for(var a=0;a<t.length;a++){var r=t[a];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var a={name:"html-audio-response",parameters:{stimulus:{type:e.ParameterType.HTML_STRING,default:void 0},stimulus_duration:{type:e.ParameterType.INT,default:null},recording_duration:{type:e.ParameterType.INT,default:2e3},show_done_button:{type:e.ParameterType.BOOL,default:!0},done_button_label:{type:e.ParameterType.STRING,default:"Continue"},record_again_button_label:{type:e.ParameterType.STRING,default:"Record again"},accept_button_label:{type:e.ParameterType.STRING,default:"Continue"},allow_playback:{type:e.ParameterType.BOOL,default:!1},save_audio_url:{type:e.ParameterType.BOOL,default:!1},show_start_button:{type:e.ParameterType.BOOL,default:!0},start_button_label:{type:e.ParameterType.STRING,default:"開始錄音"},show_textarea:{type:e.ParameterType.BOOL,default:!0},image_name:{type:e.ParameterType.STRING,default:!0}}},r=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.jsPsych=t,this.rt=null,this.recorded_data_chunks=[]}var a,r,n;return a=e,(r=[{key:"trial",value:function(e,t){this.recorder=this.jsPsych.pluginAPI.getMicrophoneRecorder(),this.setupRecordingEvents(e,t),t.show_start_button||(console.log("if (!trial.show_start_button)"),this.startRecording()),this.showDisplay(e,t),this.addButtonEvent(e,t)}},{key:"showDisplay",value:function(e,t){var a=this;new ResizeObserver((function(t,r){a.stimulus_start_time=performance.now(),r.unobserve(e)})).observe(e);var r='<div id="jspsych-html-audio-response-stimulus"><p>'.concat(t.stimulus,'</p>\n        <img src="').concat(t.image_name,'" width="90%"></div>');t.show_textarea&&(r+='<p>現在，請在心裡想一下，漫畫當中<span style="color: red">最後一張圖片中的那一個句子</span>在族語要怎麼說。</p><p>若您準備好要錄音，請按下「開始錄音」。請注意，錄音時間最長只有30秒。講完句子後，請按下「停止錄音，下一頁」。</p>'),t.show_start_button&&(r+='<p><button class="jspsych-btn" id="start-trial">'.concat(t.start_button_label,"</button></p>")),t.show_done_button&&(r+='<p><button class="jspsych-btn" id="finish-trial" disabled>'.concat(t.done_button_label,"</button></p>")),e.innerHTML=r}},{key:"hideStimulus",value:function(e){var t=e.querySelector("#jspsych-html-audio-response-stimulus");t&&(t.style.visibility="hidden")}},{key:"addButtonEvent",value:function(e,t){var a=this,r=e.querySelector("#finish-trial");r&&r.addEventListener("click",(function(){console.log("按下結束錄音");var r=performance.now();a.rt=Math.round(r-a.stimulus_start_time),a.stopRecording().then((function(){clearInterval(a.interval_id),a.jsPsych.pluginAPI.clearAllTimeouts(),t.allow_playback?a.showPlaybackControls(e,t):a.endTrial(e,t)}))}));var n=e.querySelector("#start-trial");n&&n.addEventListener("click",(function(){console.log("recording_duration: "+t.recording_duration.toString()),a.startRecording(),n.disabled=!0,r.disabled=!1;var e=t.recording_duration/1e3;n.innerHTML="正在錄音... ".concat(e,":00"),console.log("這裡"),a.interval_id=setInterval((function(){console.log("total: ".concat(e)),e-=1,n.innerHTML="正在錄音... ".concat(e,":00"),e<=0&&(console.log("clearInterval();"),clearInterval(a.interval_id))}),1e3),console.log("interval_id: ".concat(a.interval_id))}))}},{key:"setupRecordingEvents",value:function(e,t){var a=this;this.data_available_handler=function(e){e.data.size>0&&a.recorded_data_chunks.push(e.data)},this.stop_event_handler=function(){var e=new Blob(a.recorded_data_chunks,{type:"audio/mpeg"});a.audio_url=URL.createObjectURL(e);var t=new FileReader;t.addEventListener("load",(function(){var e=t.result.split(",")[1];a.response=e,a.load_resolver()})),t.readAsDataURL(e)},this.start_event_handler=function(r){console.log("start_event_handler fired"),a.recorded_data_chunks.length=0,a.recorder_start_time=r.timeStamp,t.show_start_button||(a.showDisplay(e,t),a.addButtonEvent(e,t)),e.querySelector("#start-trial"),null!==t.stimulus_duration&&a.jsPsych.pluginAPI.setTimeout((function(){a.hideStimulus(e)}),t.stimulus_duration),null!==t.recording_duration&&(console.log("trial.recording_duration: ".concat(t.recording_duration)),a.jsPsych.pluginAPI.setTimeout((function(){console.log("!!!!!"),"inactive"!==a.recorder.state&&(clearInterval(a.interval_id),a.stopRecording().then((function(){t.allow_playback?a.showPlaybackControls(e,t):a.endTrial(e,t)})))}),t.recording_duration))},this.recorder.addEventListener("dataavailable",this.data_available_handler),this.recorder.addEventListener("stop",this.stop_event_handler),this.recorder.addEventListener("start",this.start_event_handler)}},{key:"startRecording",value:function(){console.log("recording start!!!!!"),this.recorder.start()}},{key:"stopRecording",value:function(){var e=this;return this.recorder.stop(),new Promise((function(t){e.load_resolver=t}))}},{key:"showPlaybackControls",value:function(e,t){var a=this;e.innerHTML='\n      <p>您的錄音：</p>\n      <p><audio id="playback" src="'.concat(this.audio_url,'" controls></audio></p>\n      <p>（如果可以的話，請在下方欄位輸入族語文字，這個部分可填可不填。）</p><textarea id="ab" name="ab"\n          rows="5" cols="33" width="100%" style="font-size: 1.5em"></textarea>\n      <button id="record-again" class="jspsych-btn">').concat(t.record_again_button_label,'</button>\n      <button id="continue" class="jspsych-btn">').concat(t.accept_button_label,"</button>\n    "),e.querySelector("#record-again").addEventListener("click",(function(){URL.revokeObjectURL(a.audio_url),a.showDisplay(e,t),a.addButtonEvent(e,t)})),e.querySelector("#continue").addEventListener("click",(function(){a.endTrial(e,t)}))}},{key:"endTrial",value:function(e,t){if(t.show_textarea){var a=e.querySelector("#ab");this.textarea=a.value}this.recorder.removeEventListener("dataavailable",this.data_available_handler),this.recorder.removeEventListener("start",this.start_event_handler),this.recorder.removeEventListener("stop",this.stop_event_handler),this.jsPsych.pluginAPI.clearAllTimeouts();var r={rt:this.rt,stimulus:t.stimulus,response:this.response,estimated_stimulus_onset:Math.round(this.stimulus_start_time-this.recorder_start_time),textarea:this.textarea,image_name:t.image_name};t.save_audio_url?r.audio_url=this.audio_url:URL.revokeObjectURL(this.audio_url),e.innerHTML="",this.jsPsych.finishTrial(r)}}])&&t(a.prototype,r),n&&t(a,n),Object.defineProperty(a,"prototype",{writable:!1}),e}();return r.info=a,r}(jsPsychModule);
//# sourceMappingURL=index.browser.min.js.map
