{"version":3,"file":"index.browser.min.js","sources":["../src/index.ts"],"sourcesContent":["import { JsPsych, JsPsychPlugin, ParameterType, TrialType } from \"jspsych\";\n\nconst info = <const>{\n  name: \"html-audio-response\",\n  parameters: {\n    /** The HTML string to be displayed */\n    stimulus: {\n      type: ParameterType.HTML_STRING,\n      default: undefined,\n    },\n    /** How long to show the stimulus. */\n    stimulus_duration: {\n      type: ParameterType.INT,\n      default: null,\n    },\n    /** How long to show the trial. */\n    recording_duration: {\n      type: ParameterType.INT,\n      default: 2000,\n    },\n    /** Whether or not to show a button to end the recording. If false, the recording_duration must be set. */\n    show_done_button: {\n      type: ParameterType.BOOL,\n      default: true,\n    },\n    /** Label for the done (stop recording) button. Only used if show_done_button is true. */\n    done_button_label: {\n      type: ParameterType.STRING,\n      default: \"Continue\",\n    },\n    /** Label for the record again button (only used if allow_playback is true). */\n    record_again_button_label: {\n      type: ParameterType.STRING,\n      default: \"Record again\",\n    },\n    /** Label for the button to accept the audio recording (only used if allow_playback is true). */\n    accept_button_label: {\n      type: ParameterType.STRING,\n      default: \"Continue\",\n    },\n    /** Whether or not to allow the participant to playback the recording and either accept or re-record. */\n    allow_playback: {\n      type: ParameterType.BOOL,\n      default: false,\n    },\n    /** Whether or not to save the video URL to the trial data. */\n    save_audio_url: {\n      type: ParameterType.BOOL,\n      default: false,\n    },\n    /** Whether or not to show a button to end the recording. If false, the recording_duration must be set. */\n    show_start_button: {\n      type: ParameterType.BOOL,\n      default: true,\n    },\n    /** Label for the done (stop recording) button. Only used if show_done_button is true. */\n    start_button_label: {\n      type: ParameterType.STRING,\n      default: \"開始錄音\",\n    },\n    /** 是否要出現自訂的textarea **/\n    show_textarea: {\n      type: ParameterType.BOOL,\n      default: true,\n    },\n    image_name: {\n      type: ParameterType.STRING,\n      default: true,\n    },\n\n  },\n};\n\ntype Info = typeof info;\n\n/**\n * html-audio-response\n * jsPsych plugin for displaying a stimulus and recording an audio response through a microphone\n * @author Josh de Leeuw\n * @see {@link https://www.jspsych.org/plugins/jspsych-html-audio-response/ html-audio-response plugin documentation on jspsych.org}\n */\nclass HtmlAudioResponsePlugin implements JsPsychPlugin<Info> {\n  static info = info;\n  private stimulus_start_time;\n  private recorder_start_time;\n  private recorder: MediaRecorder;\n  private audio_url;\n  private response;\n  private load_resolver;\n  private rt: number = null;\n  private start_event_handler;\n  private stop_event_handler;\n  private data_available_handler;\n  private recorded_data_chunks = [];\n  private textarea;\n  private interval_id;\n\n  constructor(private jsPsych: JsPsych) {}\n\n  trial(display_element: HTMLElement, trial: TrialType<Info>) {\n    this.recorder = this.jsPsych.pluginAPI.getMicrophoneRecorder();\n\n    this.setupRecordingEvents(display_element, trial);\n    \n\n    // 要改成按下按鈕才開始錄音\n    // this.startRecording();\n\n    if (!trial.show_start_button) {\n      console.log('if (!trial.show_start_button)');\n      this.startRecording();\n    }\n\n    this.showDisplay(display_element, trial);\n    this.addButtonEvent(display_element, trial);\n    \n  }\n\n  private showDisplay(display_element, trial) {\n    const ro = new ResizeObserver((entries, observer) => {\n      this.stimulus_start_time = performance.now();\n      observer.unobserve(display_element);\n      //observer.disconnect();\n    });\n\n    ro.observe(display_element);\n\n    // let html = `<div id=\"jspsych-html-audio-response-stimulus\">${trial.stimulus}</div>`;\n    let html = `<div id=\"jspsych-html-audio-response-stimulus\"><p>${trial.stimulus}</p>\n        <img src=\"${trial.image_name}\" width=\"90%\"></div>`;\n\n    \n\n    // console.log(trial.show_textarea);\n\n    if (trial.show_textarea) {\n      html += `<p>現在，請在心裡想一下，漫畫當中<span style=\"color: red\">最後一張圖片中的那一個句子</span>在族語要怎麼說。</p><p>若您準備好要錄音，請按下「開始錄音」。請注意，錄音時間最長只有30秒。講完句子後，請按下「停止錄音，下一頁」。</p>`\n    }\n\n    if (trial.show_start_button) {\n      html += `<p><button class=\"jspsych-btn\" id=\"start-trial\">${trial.start_button_label}</button></p>`;\n    }\n\n    if (trial.show_done_button) {\n      html += `<p><button class=\"jspsych-btn\" id=\"finish-trial\" disabled>${trial.done_button_label}</button></p>`;\n    }\n\n\n\n    display_element.innerHTML = html;\n  }\n\n  private hideStimulus(display_element: HTMLElement) {\n    const el: HTMLElement = display_element.querySelector(\"#jspsych-html-audio-response-stimulus\");\n    if (el) {\n      el.style.visibility = \"hidden\";\n    }\n  }\n\n  private addButtonEvent(display_element, trial) {\n    const btn_finish = display_element.querySelector(\"#finish-trial\");\n    if (btn_finish) {\n      btn_finish.addEventListener(\"click\", () => {\n        const end_time = performance.now();\n        this.rt = Math.round(end_time - this.stimulus_start_time);\n        this.stopRecording().then(() => {\n          // 清除倒數;\n          clearInterval(this.interval_id);\n          if (trial.allow_playback) {\n            this.showPlaybackControls(display_element, trial);\n          } else {\n            this.endTrial(display_element, trial);\n          }\n        });\n      });\n    }\n\n    const btn_start = display_element.querySelector(\"#start-trial\");\n    if (btn_start) {\n      btn_start.addEventListener(\"click\", () => {\n        console.log('recording_duration: ' + trial.recording_duration.toString());\n        this.startRecording();\n        btn_start.disabled = true;\n        btn_finish.disabled = false;\n        var total = trial.recording_duration / 1000;\n        btn_start.innerHTML = `正在錄音... ${total}:00`;\n\n        console.log('這裡');\n        this.interval_id = setInterval(() => {\n          console.log(`total: ${total}`);\n          total -= 1;\n          btn_start.innerHTML = `正在錄音... ${total}:00`;\n          if (total <= 0) {\n            console.log('clearInterval();');\n            clearInterval(this.interval_id);\n          }\n        }, 1000);\n        console.log(`interval_id: ${this.interval_id}`);\n      \n      \n      });\n    }\n  }\n\n  private setupRecordingEvents(display_element, trial) {\n    this.data_available_handler = (e) => {\n      if (e.data.size > 0) {\n        this.recorded_data_chunks.push(e.data);\n      }\n    };\n\n    this.stop_event_handler = () => {\n      const data = new Blob(this.recorded_data_chunks, { type: \"audio/mpeg\" });\n      this.audio_url = URL.createObjectURL(data);\n      const reader = new FileReader();\n      reader.addEventListener(\"load\", () => {\n        const base64 = (reader.result as string).split(\",\")[1];\n        this.response = base64;\n        this.load_resolver();\n      });\n      reader.readAsDataURL(data);\n\n      \n\n    };\n\n    this.start_event_handler = (e) => {\n      console.log('start_event_handler fired');\n\n      // resets the recorded data\n      this.recorded_data_chunks.length = 0;\n\n      this.recorder_start_time = e.timeStamp;\n      \n      if (!trial.show_start_button) {\n        this.showDisplay(display_element, trial);\n        this.addButtonEvent(display_element, trial);\n      }\n\n      const btn_start = display_element.querySelector(\"#start-trial\");\n    \n\n      // var total = trial.recording_duration / 1000;\n\n      // if (btn_start) {\n      //   console.log('這裡');\n      //   this.interval_id = setInterval(() => {\n      //     console.log(`total: ${total}`);\n      //     total -= 1;\n      //     btn_start.innerHTML = `正在錄音... ${total}:00`;\n      //     if (total <= 0) {\n      //       console.log('clearInterval();');\n      //       clearInterval(this.interval_id);\n      //     }\n      //   }, 1000);\n      //   console.log(`interval_id: ${this.interval_id}`);\n      \n      // }\n\n      // this.showDisplay(display_element, trial);\n      // this.addButtonEvent(display_element, trial);\n\n      // setup timer for hiding the stimulus\n      if (trial.stimulus_duration !== null) {\n        this.jsPsych.pluginAPI.setTimeout(() => {\n          this.hideStimulus(display_element);\n        }, trial.stimulus_duration);\n      }\n\n      // setup timer for ending the trial\n      if (trial.recording_duration !== null) {\n        this.jsPsych.pluginAPI.setTimeout(() => {\n          // this check is necessary for cases where the\n          // done_button is clicked before the timer expires\n          if (this.recorder.state !== \"inactive\") {\n            clearInterval(this.interval_id);\n            this.stopRecording().then(() => {\n              if (trial.allow_playback) {\n                this.showPlaybackControls(display_element, trial);\n              } else {\n                this.endTrial(display_element, trial);\n              }\n            });\n          }\n        }, trial.recording_duration);\n      }\n    };\n\n    this.recorder.addEventListener(\"dataavailable\", this.data_available_handler);\n\n    this.recorder.addEventListener(\"stop\", this.stop_event_handler);\n\n    this.recorder.addEventListener(\"start\", this.start_event_handler);\n  }\n\n  private startRecording() {\n    console.log('recording start!!!!!');\n    this.recorder.start();\n  }\n\n  private stopRecording() {\n    this.recorder.stop();\n    return new Promise((resolve) => {\n      this.load_resolver = resolve;\n    });\n  }\n\n  private showPlaybackControls(display_element, trial) {\n  \n    display_element.innerHTML = `\n      <p>您的錄音：</p>\n      <p><audio id=\"playback\" src=\"${this.audio_url}\" controls></audio></p>\n      <p>（如果可以的話，請在下方欄位輸入族語文字，這個部分可填可不填。）</p><textarea id=\"ab\" name=\"ab\"\n          rows=\"5\" cols=\"33\" width=\"100%\" style=\"font-size: 1.5em\"></textarea>\n      <button id=\"record-again\" class=\"jspsych-btn\">${trial.record_again_button_label}</button>\n      <button id=\"continue\" class=\"jspsych-btn\">${trial.accept_button_label}</button>\n    `;\n\n    // var result = '';\n    // if (this.textarea.length == 0) {\n    //   result = \"(空白)\";\n    // } else {\n    //   result = this.textarea;\n    // }\n \n    // if (trial.show_textarea) {\n    //   display_element.innerHTML = `<p>您的錄音：</p>` + display_element.innerHTML + ``;\n    // }\n\n    display_element.querySelector(\"#record-again\").addEventListener(\"click\", () => {\n      // release object url to save memory\n      URL.revokeObjectURL(this.audio_url);\n      \n      // this.startRecording();\n      this.showDisplay(display_element, trial);\n      this.addButtonEvent(display_element, trial);\n    });\n    display_element.querySelector(\"#continue\").addEventListener(\"click\", () => {\n      this.endTrial(display_element, trial);\n    });\n\n    // const audio = display_element.querySelector('#playback');\n    // audio.src =\n  }\n\n  private endTrial(display_element, trial) {\n    // 處理輸入文字\n    if (trial.show_textarea) {\n        let ab = display_element.querySelector(\"#ab\");\n        this.textarea = ab.value;\n      }\n\n\n    // clear recordering event handler\n\n    this.recorder.removeEventListener(\"dataavailable\", this.data_available_handler);\n    this.recorder.removeEventListener(\"start\", this.start_event_handler);\n    this.recorder.removeEventListener(\"stop\", this.stop_event_handler);\n\n    // kill any remaining setTimeout handlers\n    this.jsPsych.pluginAPI.clearAllTimeouts();\n\n    // gather the data to store for the trial\n    var trial_data: any = {\n      rt: this.rt,\n      stimulus: trial.stimulus,\n      response: this.response,\n      estimated_stimulus_onset: Math.round(this.stimulus_start_time - this.recorder_start_time),\n      textarea: this.textarea,\n      image_name: trial.image_name\n    };\n\n    if (trial.save_audio_url) {\n      trial_data.audio_url = this.audio_url;\n    } else {\n      URL.revokeObjectURL(this.audio_url);\n    }\n\n    // clear the display\n    display_element.innerHTML = \"\";\n\n    // move on to the next trial\n    this.jsPsych.finishTrial(trial_data);\n  }\n}\n\nexport default HtmlAudioResponsePlugin;\n"],"names":["info","name","parameters","stimulus","type","ParameterType","HTML_STRING","default","undefined","stimulus_duration","INT","recording_duration","show_done_button","BOOL","done_button_label","STRING","record_again_button_label","accept_button_label","allow_playback","save_audio_url","show_start_button","start_button_label","show_textarea","image_name","HtmlAudioResponsePlugin","jsPsych","_classCallCheck","this","rt","recorded_data_chunks","display_element","trial","recorder","pluginAPI","getMicrophoneRecorder","setupRecordingEvents","console","log","startRecording","showDisplay","addButtonEvent","_this","ResizeObserver","entries","observer","stimulus_start_time","performance","now","unobserve","observe","html","innerHTML","value","el","querySelector","style","visibility","_this2","btn_finish","addEventListener","end_time","Math","round","stopRecording","then","clearInterval","interval_id","showPlaybackControls","endTrial","btn_start","toString","disabled","total","concat","setInterval","_this3","data_available_handler","e","data","size","push","stop_event_handler","Blob","audio_url","URL","createObjectURL","reader","FileReader","base64","result","split","response","load_resolver","readAsDataURL","start_event_handler","length","recorder_start_time","timeStamp","setTimeout","hideStimulus","state","start","_this4","stop","Promise","resolve","_this5","revokeObjectURL","ab","textarea","removeEventListener","clearAllTimeouts","trial_data","estimated_stimulus_onset","finishTrial"],"mappings":"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"}